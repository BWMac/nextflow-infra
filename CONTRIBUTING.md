# Contribution Guidelines

For more information on how this repository was set up, jump to [this section](#how-this-repository-was-set-up) below.

## Setting up the repository for development

You must first install [`pipenv`](https://pipenv.pypa.io/en/latest/install/#installing-pipenv) and the [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html).

For testing, you can use the `workflows-nextflow-dev` AWS account that was set up [here](https://github.com/Sage-Bionetworks-IT/organizations-infra/blob/3dfe3fe2db327bd07cf31610cd77f02c3bacc130/org-formation/organization.yaml#L316-L326). You can [open an issue](https://github.com/Sage-Bionetworks-Workflows/aws-workflows-nextflow-infra/issues/new/choose) to request for access to the AWS account. One of the project admins will create an IAM user in this AWS account and share the credentials in a secure way.

```
# Install dependencies in isolated virtual environment
pipenv install --dev

# Install pre-commit hooks into Git
pipenv run pre-commit install

# Set up an AWS CLI profile with admin access for a test account
aws configure --profile $AWS_PROFILE
```

## Testing sceptre deployment

If your text editor (_e.g._ Visual Studio Code) or shell (_e.g._ using [`direnv`](https://direnv.net/)) can automatically activate the `pipenv` virtual environment, you can omit the `pipenv shell` command.

```
# Activate the pipenv virtual environment to use sceptre
pipenv shell

# Test the deployment of the 'prod' stack group
sceptre --var "profile=$AWS_PROFILE" launch --yes prod

# Delete the test deployment of the 'prod' stack group
sceptre --var "profile=$AWS_PROFILE" delete --yes prod
```

## How this repository was set up

1. Create a PR on the `organizations-infra` [repository](https://github.com/Sage-Bionetworks-IT/organizations-infra) to create an AWS account using `org-formation`.
   - This was done twice in this case so we have both a more restricted production account and a sandbox-like development account.
   - Here are the PRs for the [production account](https://github.com/Sage-Bionetworks-IT/organizations-infra/pull/130) and the [development account](https://github.com/Sage-Bionetworks-IT/organizations-infra/pull/131).
2. Create a PR on the `organizations-infra` [repository](https://github.com/Sage-Bionetworks-IT/organizations-infra) to set up access to the above AWS account via JumpCloud.
   - Once again, this was done twice, once per account.
   - Here are the PRs for the [production account](https://github.com/Sage-Bionetworks-IT/organizations-infra/pull/135) and the [development account](https://github.com/Sage-Bionetworks-IT/organizations-infra/pull/136).
   - Note that the PRs include an XML file that needs to be manually generated by the IT team. You can create the PR with a placeholder XML file and they will provide the actual file once they see the PR.
   - Once these PRs are merged, the corresponding accounts appeared under Applications in [JumpCloud](https://console.jumpcloud.com/).
3. Create a PR on the `organizations-infra` [repository](https://github.com/Sage-Bionetworks-IT/organizations-infra) to create an AWS service account using `org-formation`.
   - In this context, "service account" doesn't refer to an AWS account.
   - The [CloudFormation template](https://github.com/Sage-Bionetworks/aws-infra/blob/master/templates/IAM/service-account.yaml) for the service account creates both an IAM service user and an IAM service role.
   - Here's the [PR](https://github.com/Sage-Bionetworks-IT/organizations-infra/pull/141) for both the production and development accounts.
   - Information relevant for subsequent steps (_e.g._ service user credentials, role ARN) was found in the CloudFormation AWS Console, which can be accessed via JumpCloud, under the stack name used in this PR, namely `workflows-nextflow-ci-service-account`.
4. Store the service user credentials as secrets on the [Sage-Bionetworks-Workflows](https://github.com/Sage-Bionetworks-Workflows) GitHub organization and restrict access to the relevant repositories, including this one.
   - In this case, the secrets were called `NEXTFLOW_PROD_CI_ACCESS_KEY` and `NEXTFLOW_PROD_CI_SECRET_ACCESS_KEY`.
5. Configure the repository to use pre-commit and pipenv.
   - The initial setup can be seen in [this commit](https://github.com/Sage-Bionetworks-Workflows/aws-workflows-nextflow-infra/tree/fde12b5aa1f9c399ed6175de96093f02cbf2cb33), but it's probably best to look at the [latest version](https://github.com/Sage-Bionetworks-Workflows/aws-workflows-nextflow-infra) of these files.
6. Configure the GitHub Actions CI [workflow](https://github.com/Sage-Bionetworks-Workflows/aws-workflows-nextflow-infra/blob/prod/.github/workflows/aws-deploy.yaml) on this repository.
   - You can read through [this PR](https://github.com/Sage-Bionetworks-Workflows/aws-workflows-nextflow-infra/pull/1) to find out more about the rationale for the current design of the CI workflow.
